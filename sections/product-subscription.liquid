{% schema %}
{
  "name": "Plan Selector",
  "blocks": [],
  "tag": "section",
  "class": "product-plan-selector",
  "limit": 1,
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": []
}
{% endschema %}

<div id="subscription-block" class="subscription-block">
  <style>
    .hide-qty .product-form__quantity { display: none !important; }
    .plan-options, .flavor-select-block { display: none; margin-top: 1rem; }
    .flavor-options label { display: inline-block; margin: 0 10px; text-align: center; }
    .flavor-options img { max-width: 60px; display: block; margin: 0 auto 5px; }
  </style>

  <div>
    <h3>Select Your Plan</h3>
    {% assign plans = product.selling_plan_groups %}
    <div class="radio-group">
      {% for plan_group in plans %}
        {% assign plan_handle = plan_group.name | handleize %}
        <label>
          <input
            type="radio"
            name="plan_type"
            value="{{ plan_handle }}"
            data-plan-id="{{ plan_group.selling_plans[0].id }}"
            {% if forloop.first %}checked{% endif %}
          >
          {{ plan_group.name }} – ₹{{ plan_group.selling_plans[0].price_adjustments[0].value | divided_by: 100 }}
        </label>
      {% endfor %}
    </div>
  </div>

  {% comment %} Flavor images (can be metafields or static assets) {% endcomment %}
  {% assign flavors = "Chocolate,Vanilla,Orange" | split: "," %}
  {% assign flavor_images = "chocolate.png,vanilla.png,orange.png" | split: "," %}

  <div id="flavor-section" class="flavor-select-block">
    <h4>Select a Flavor</h4>
    <div class="flavor-options">
      {% for flavor in flavors %}
        {% assign image = flavor_images[forloop.index0] %}
        <label>
          <input type="radio" name="selected_flavor" value="{{ flavor }}">
          <img src="{{ image | asset_url }}" alt="{{ flavor }}">
          <div>{{ flavor }}</div>
        </label>
      {% endfor %}
    </div>
  </div>

  <input type="hidden" id="selling-plan-input" name="selling_plan">

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form[action^="/cart"]');
      const body = document.body;

      // Hide quantity selector
      if (form) body.classList.add('hide-qty');

      const planRadios = document.querySelectorAll('input[name="plan_type"]');
      const flavorBlock = document.getElementById('flavor-section');
      const sellingPlanInput = document.getElementById('selling-plan-input');

      function showSelectedFlavor(planId) {
        sellingPlanInput.value = planId;
        flavorBlock.style.display = 'block';

        // Move flavor block under selected radio
        const selectedLabel = document.querySelector('input[name="plan_type"]:checked').parentNode;
        selectedLabel.insertAdjacentElement('afterend', flavorBlock);
      }

      planRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          showSelectedFlavor(this.dataset.planId);
        });

        // Initial set
        if (radio.checked) {
          showSelectedFlavor(radio.dataset.planId);
        }
      });
    });
  </script>
</div>
